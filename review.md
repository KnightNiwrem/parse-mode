## HTML Parser Review Findings

- **Fragile attribute parsing (`src/html-parser.ts`, lines ~55-97):** Tag attributes are split on single spaces and the values are `JSON.parse`d. This rejects valid HTML attributes (single-quoted strings, values containing spaces, escaped quotes) and cannot detect presence-only flags like `<blockquote expandable>`. A production Telegram payload that includes these will either throw or silently mis-handle the attribute.
- **Incorrect spoiler span bookkeeping (`src/html-parser.ts`, lines ~109-150):** Every closing `</span>` is treated as a spoiler terminator, even when the opening `<span>` was not recognised as a `tg-spoiler`. Literal spans therefore drop text into `entityTagParts` and lose formatting boundaries.
- **`<pre>`/`<code>` handling diverges from spec (`src/html-parser.ts`, lines ~158-189):** The parser expects a nonexistent `language` attribute on `<pre>` while the Bot API requires `<pre><code class="language-...">`. As a consequence, language hints are ignored and nested `<code>` creates extra entities.
- **HTML entity decoding is incomplete (`src/html-parser.ts`, lines ~32-82):** Only `&amp;`, `&lt;`, `&gt;`, and `&quot;` are decoded; numeric and hexadecimal entities (explicitly supported per the spec) remain raw, and unterminated sequences at EOF are dropped.
- **Expandable blockquotes unsupported (`src/html-parser.ts`, lines ~180-204):** `<blockquote expandable>` should become an `expandable_blockquote` entity, but the parser neither detects the attribute nor validates it, so the feature is currently unavailable.
- **State cleanup gaps at EOF (`src/html-parser.ts`, entire state machine):** If the input ends while reading an escape sequence or a tag, the pending buffer is discarded instead of being flushed back to text, truncating output for malformed but acceptable user messages.
